<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>2D Fighting Game</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
    </style>
</head>
<body>

<script type="text/javascript">
    
var game = new Phaser.Game(1024, 525, Phaser.AUTO, '', {preload: preload, create: create, update: update, render: render});
    
function preload() {
	game.load.image('dojo_bg', 'assets/dojo_background.jpg');
    game.load.image('dark_bg', 'assets/dark_background.jpg');
    //game.load.spritesheet('ryuStand', 'assets/ryuStand80x111.png', 80, 111);
    game.load.spritesheet('ryu', 'assets/RyuSpriteMap125x135.png', 125, 135);
    game.load.spritesheet('enemy', 'assets/enemy.png', 76, 108);
    game.load.spritesheet('ken', 'assets/ken-sprite-sheet.png', 103, 135);
}

var player1;
var player2;	
var cursors;
var hitboxes1;
var timer;
var timerEvent;
var text;

function create() {
	game.physics.startSystem(Phaser.Physics.ARCADE);
	game.add.sprite(0,0,'dojo_bg');
    
    timer = game.time.create();
    timerEvent = timer.add(Phaser.Timer.SECOND * 2, endTimer, this);
    
    timer.start();

    player1 = game.add.sprite(500, 400, 'ryu');
    player2 = game.add.sprite(850, 400, 'ken');
    player1.scale.setTo(2,2);
    player2.scale.setTo(1.78,1.78);

    game.physics.arcade.enable(player1);
    game.physics.arcade.enable(player2);
    game.physics.arcade.collide(player1, player2);

    player1.body.bounce.y = 0.2;
    player1.body.gravity.y = 800;
    player1.body.collideWorldBounds = true;
    player2.body.bounce.y = 0.2;
    player2.body.gravity.y = 800;
    player2.body.collideWorldBounds = true;

    player1.body.setSize(85,120,25,25);

    hitboxes1 = game.add.group();
    hitboxes1.enableBody = true;
    player1.addChild(hitboxes1);

    var hitbox1 = hitboxes1.create(500,340,null);
    hitbox1.body.setSize(100, 100, 85, 120 / 2);
    hitbox1.name = 'trial';
    enableHitbox('trial');


    player1.animations.add('idle', [0, 1, 2, 3, 4, 5], 5, true);
    player1.animations.add('backwards', [6, 7, 8, 9, 10, 11], 5, true);
    player1.animations.add('forwards', [12, 13, 14, 15, 16, 17], 5, true);
    player1.animations.add('jump', [18, 19, 20, 21, 22, 23], 5, true);
    player1.animations.add('shoruken', [24, 25, 26, 27, 28, 29], 7, true);
    player1.animations.add('crouch', [42], 5, true);
    
    player2.animations.add('idle', [0, 1, 2, 3, 4, 5, 6, 7, 8], 5, true);
    player2.animations.add('backwards', [10, 11, 12, 13, 14], 5, true);
    player2.animations.add('forwards', [15, 16, 17, 18, 19], 5, true);
    player2.animations.add('jump', [25, 27, 28, 29, 30,31,32,33,34], 7, true);
    player2.animations.add('crouch', [23], 5, true);
    
    
    cursors = game.input.keyboard.createCursorKeys();

}    

function enableHitbox(hitboxName) {
    for(var i = 0; i < hitboxes1.children.length; i++){

        if(hitboxes1.children[i].name === hitboxName){
            hitboxes1.children[i].reset(0,0);               

        }
    }
}

function disableAllHitboxes() {     
    hitboxes1.forEachExists(function(hitbox) {          
        hitbox.kill();     
    });
}

function update() {
    player1.body.velocity.x = 0;
    player2.body.velocity.x = 0;
    
    upButton = game.input.keyboard.addKey(Phaser.Keyboard.W);
    downButton = game.input.keyboard.addKey(Phaser.Keyboard.S);
    leftButton = game.input.keyboard.addKey(Phaser.Keyboard.A);
    rightButton = game.input.keyboard.addKey(Phaser.Keyboard.D);

    game.physics.arcade.overlap(player1, player2, overlap, null, this);

    //player1 controls
    if (cursors.left.isDown && cursors.right.isDown) {
            player1.animations.play('shoruken');
        }

    else if (cursors.left.isDown) {
            //  Move to the left
            player1.body.velocity.x = -200;
            if (player1.body.onFloor()) {
                player1.animations.play('backwards');
            }
        }
    else if (cursors.right.isDown) {
            //  Move to the left
            player1.body.velocity.x = 200;
            if (player1.body.onFloor()) {
                player1.animations.play('forwards');
            }
        } 
    else if (cursors.down.isDown) {
            // crouch
            player1.body.velocity.x = 0;
            player1.animations.play('crouch');
        }
    else {
        //  Stand still
        if (player1.body.onFloor()) {
            player1.animations.play('idle');
        }
        //player.frame = 2;
    }
    if (cursors.up.isDown && player1.body.onFloor()){
            //  Jump
            player1.body.velocity.y = -500;
            player1.animations.play('jump');
        }

    
    
    //player2 controls
    if (leftButton.isDown) {
        player2.body.velocity.x = -150;
        if (player2.body.onFloor()) {
            player2.animations.play('forwards');
        }
    } 
    else if (rightButton.isDown) {
        player2.body.velocity.x = 150;
        if (player2.body.onFloor()) {
            player2.animations.play('backwards');
        }

    } 
    else if (downButton.isDown) {
            // crouch
        player2.body.velocity.x = 0;
        player2.animations.play('crouch');
    }
    else {
        if (player2.body.onFloor()) {
            player2.animations.play('idle');
        }
    }
    if (upButton.isDown && player2.body.onFloor()){
            //  Jump
            player2.body.velocity.y = -500;
            player2.animations.play('jump');
        }

}
    
function render() {
    
    if(timer.running) {
        game.debug.text(formatTime(Math.round((timerEvent.delay - timer.ms) / 1000)), 483, 60, "#ffb64d", '60px ScriptoramaMarkdownJF');
    }
    else {
        game.debug.text("End of Round", 200, 250, "#ffb64d", '100px ScriptoramaMarkdownJF');
    }
    
    function formatTime(s) {
        var minutes = "0" + Math.floor(s / 60);
        var seconds = "0" + (s - minutes * 60);
        return seconds.substr(-2);  
    }
    
    game.debug.body(player1);
    game.debug.body(player2);

    hitboxes1.forEachAlive(renderGroup, this);

}

function endTimer() {
    timer.stop();
}
function renderGroup(member) { 
   game.debug.body(member);
}

function overlap(player1, player2) {

    player2.kill();
    console.log('killed player 2');
}

    
</script>
</body>
</html>
